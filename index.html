<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Black Stones - SÃ¼rpriz Pasta</title>
  <style>
    :root{--bg:#0b0b14;--accent:#ffb6c1;--text:#fff}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#0b0b14 0%, #121217 100%);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);-webkit-tap-highlight-color:transparent}
    #app{height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden}
    #topbar{position:fixed;left:12px;right:12px;top:12px;display:flex;justify-content:space-between;align-items:center;z-index:60}
    .btn{background:rgba(255,255,255,0.06);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:12px;color:var(--text);font-size:14px}
    #message{position:fixed;left:50%;transform:translateX(-50%);top:10vh;background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.03));padding:10px 16px;border-radius:14px;font-weight:600;color:var(--text);z-index:50}
    #hint{position:fixed;left:12px;bottom:14px;z-index:50;background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:10px;font-size:13px}
    #canvas-wrap{width:100%;height:100vh;display:block}
    canvas{display:block}
    #controls{position:fixed;right:12px;bottom:12px;z-index:60;display:flex;flex-direction:column;gap:8px}
    input[type=file]{display:none}
    .label{font-size:13px}
    #overlayCenter{position:fixed;left:50%;top:54%;transform:translate(-50%,-50%);z-index:55;text-align:center}
    #wishMsg{font-size:18px;color:var(--accent);font-weight:700;text-shadow:0 6px 18px rgba(0,0,0,0.6)}
    #start-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:200}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));padding:20px;border-radius:16px;text-align:center;border:1px solid rgba(255,255,255,0.04)}
    .big{font-size:20px;margin-bottom:10px}
    .small{font-size:13px;color:rgba(255,255,255,0.7)}
    @media(min-width:900px){#overlayCenter{top:50%}}
  </style>
</head>
<body>
  <div id="app">
    <div id="topbar">
      <label class="btn">
        GÃ¶rsel YÃ¼kle
        <input id="imageFile" type="file" accept="image/*">
      </label>
      <div style="display:flex;gap:8px">
        <button id="resetBtn" class="btn">SÄ±fÄ±rla</button>
      </div>
    </div>

    <div id="message">Dilek dilemeyi unutma!! ðŸ’«</div>
    <div id="hint">Mikrofonunu kullanarak Ã¼fle: ses yÃ¼kseldiÄŸinde mumlar sÃ¶necek ve ÅŸarkÄ± baÅŸlayacak.</div>

    <div id="canvas-wrap"></div>

    <div id="controls">
      <button id="micBtn" class="btn">Mikrofonu AÃ§</button>
    </div>

    <div id="overlayCenter">
      <div id="wishMsg">Dilek dilemeyi unutma!! ðŸ’«</div>
    </div>

    <div id="start-screen">
      <div class="card">
        <div class="big">Black Stones - SÃ¼rpriz Pasta</div>
        <div class="small">Dikey (mobil) gÃ¶rÃ¼nÃ¼m iÃ§in hazÄ±rlandÄ±. LÃ¼tfen mikrofona izin ver ve "Mikrofonu AÃ§" tuÅŸuna bas.</div>
        <div style="height:12px"></div>
        <button id="startBtn" class="btn">BaÅŸlat</button>
      </div>
    </div>
  </div>

  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.154.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.154.0/examples/js/controls/OrbitControls.js"></script>
  <!-- YouTube Iframe API -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
  (function(){
    const canvasWrap = document.getElementById('canvas-wrap');
    const startScreen = document.getElementById('start-screen');
    const startBtn = document.getElementById('startBtn');
    const micBtn = document.getElementById('micBtn');
    const resetBtn = document.getElementById('resetBtn');
    const imageFile = document.getElementById('imageFile');
    const wishMsg = document.getElementById('wishMsg');
    const message = document.getElementById('message');

    // THREE setup
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0,3.2,6);
    const renderer = new THREE.WebGLRenderer({antialias:true,alpha:true});
    renderer.setPixelRatio(window.devicePixelRatio || 1);
    renderer.setSize(window.innerWidth, window.innerHeight);
    canvasWrap.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.enablePan = false;
    controls.minDistance = 4; controls.maxDistance = 10;

    const hemi = new THREE.HemisphereLight(0xfff7f3, 0x332b40, 0.9);
    scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 0.8);
    dir.position.set(2,6,2); scene.add(dir);

    const ground = new THREE.Mesh(new THREE.PlaneGeometry(40,40), new THREE.MeshStandardMaterial({color:0x0b0b10,roughness:0.9}));
    ground.rotation.x = -Math.PI/2; ground.position.y = -1.0; scene.add(ground);

    // cake
    const cakeGroup = new THREE.Group();
    const bottom = new THREE.Mesh(new THREE.CylinderGeometry(2.6,2.6,1.4,64), new THREE.MeshStandardMaterial({color:0xFFD7E0,roughness:0.6}));
    bottom.position.y = 0.6; cakeGroup.add(bottom);
    const top = new THREE.Mesh(new THREE.CylinderGeometry(2.2,2.2,0.18,64), new THREE.MeshStandardMaterial({color:0xffffff,roughness:0.4}));
    top.position.y = 1.22; cakeGroup.add(top);
    scene.add(cakeGroup);

    // center text plane
    const textCanvas = document.createElement('canvas'); textCanvas.width=1024; textCanvas.height=256;
    const txCtx = textCanvas.getContext('2d');
    function drawCenterText(txt){
      txCtx.clearRect(0,0,textCanvas.width,textCanvas.height);
      txCtx.fillStyle='rgba(0,0,0,0)'; txCtx.fillRect(0,0,textCanvas.width,textCanvas.height);
      txCtx.font = 'bold 140px serif'; txCtx.textAlign='center'; txCtx.textBaseline='middle';
      txCtx.fillStyle = '#0b0b14';
      txCtx.fillText(txt, textCanvas.width/2, textCanvas.height/2+6);
      txCtx.strokeStyle='#ffefe9'; txCtx.lineWidth=6; txCtx.strokeText(txt, textCanvas.width/2, textCanvas.height/2+6);
      txCtx.fillStyle='#fff'; txCtx.fillText(txt, textCanvas.width/2, textCanvas.height/2+6);
      if(centerMat.map) centerMat.map.needsUpdate=true;
    }
    const centerTex = new THREE.CanvasTexture(textCanvas);
    const centerMat = new THREE.MeshStandardMaterial({map:centerTex,transparent:true});
    const centerPlane = new THREE.Mesh(new THREE.PlaneGeometry(3.6,0.9), centerMat);
    centerPlane.rotation.x = -Math.PI/2.05; centerPlane.position.y = 1.29; centerPlane.position.z = 0.01; centerPlane.renderOrder=2;
    scene.add(centerPlane);
    drawCenterText('Black Stones');

    const topMat = top.material;
    imageFile.addEventListener('change',(e)=>{
      const f = e.target.files[0]; if(!f) return;
      const url = URL.createObjectURL(f);
      const loader = new THREE.TextureLoader();
      loader.load(url, (t)=>{ t.anisotropy = renderer.capabilities.getMaxAnisotropy(); topMat.map = t; topMat.needsUpdate=true; });
    });

    const candles = [];
    const candleCount = 6;
    for(let i=0;i<candleCount;i++){
      const angle = i*(Math.PI*2)/candleCount - Math.PI/6;
      const r = 1.5;
      const x = Math.cos(angle)*r; const z = Math.sin(angle)*r;
      const g = new THREE.Group();
      const body = new THREE.Mesh(new THREE.CylinderGeometry(0.06,0.06,0.62,12), new THREE.MeshStandardMaterial({color:0xffffff,roughness:0.8}));
      body.position.y = 1.6; g.add(body);
      const stripe = new THREE.Mesh(new THREE.CylinderGeometry(0.062,0.062,0.08,12), new THREE.MeshStandardMaterial({color:0xffc6d1}));
      stripe.position.y = 1.77; g.add(stripe);
      const flameCan = document.createElement('canvas'); flameCan.width=64; flameCan.height=128; const fctx = flameCan.getContext('2d');
      const grad = fctx.createLinearGradient(32,8,32,120); grad.addColorStop(0,'#fff1c9'); grad.addColorStop(0.5,'#ff7a7a'); grad.addColorStop(1,'rgba(255,122,122,0)');
      fctx.fillStyle = grad; fctx.beginPath(); fctx.ellipse(32,48,18,36,0,0,Math.PI*2); fctx.fill();
      const flameTex = new THREE.CanvasTexture(flameCan); const flameMat = new THREE.SpriteMaterial({map:flameTex,transparent:true});
      const sprite = new THREE.Sprite(flameMat); sprite.position.y = 1.98; sprite.scale.set(0.45,0.9,1); g.add(sprite);
      g.position.set(x,0,z);
      g.lookAt(0,1.3,0);
      scene.add(g);
      candles.push({group:g,flame:sprite,alive:true});
    }

    const smokeGeo = new THREE.PlaneGeometry(0.6,0.6);
    const smokeMat = new THREE.MeshStandardMaterial({color:0xffffff,transparent:true,opacity:0.18,depthWrite:false});
    const smokes = [];

    // mic audio detection
    let audioContext, mediaStream, analyser, dataArray, sourceNode;
    let micActive = false;
    async function enableMic(){
      if(micActive) return;
      try{
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
        sourceNode = audioContext.createMediaStreamSource(mediaStream);
        analyser = audioContext.createAnalyser(); analyser.fftSize = 2048;
        sourceNode.connect(analyser);
        dataArray = new Uint8Array(analyser.fftSize);
        micActive = true; micBtn.textContent='Mikrofon AÃ§Ä±k';
      }catch(e){alert('Mikrofon eriÅŸimi reddedildi veya desteklenmiyor.');}
    }

    micBtn.addEventListener('click', ()=>{ if(!micActive) enableMic(); else { if(mediaStream){mediaStream.getTracks().forEach(t=>t.stop()); micActive=false; micBtn.textContent='Mikrofonu AÃ§';}} });

    // YouTube player setup (invisible iframe)
    let ytPlayerReady=false, ytPlayer;
    window.onYouTubeIframeAPIReady = function(){
      // videoId below chosen from YouTube search; if bÃ¶lgesel kÄ±sÄ±tlama veya farklÄ± video istersen sÃ¶yle, deÄŸiÅŸtiririm.
      ytPlayer = new YT.Player('ytplayer', {height:'0',width:'0',videoId:'1V4AscLidWg',playerVars:{'playsinline':1,'rel':0,'controls':0,'disablekb':1,'modestbranding':1}});
      ytPlayerReady=true;
    };

    let blown=false;
    function checkBlow(){
      if(!micActive || !analyser) return;
      analyser.getByteTimeDomainData(dataArray);
      let sum=0; for(let i=0;i<dataArray.length;i++){const v=(dataArray[i]-128)/128; sum += v*v;}
      const rms = Math.sqrt(sum/dataArray.length);
      if(rms>0.12 && !blown){
        triggerBlow();
      }
    }

    function triggerBlow(){
      blown = true;
      candles.forEach((c,idx)=>{
        c.alive=false;
        // animate flame scale to zero (quick manual step)
        const startX = c.flame.scale.x, startY = c.flame.scale.y;
        const dur = 800, t0 = performance.now();
        (function step(){ const t = Math.min((performance.now()-t0)/dur,1); const ease = 1 - Math.pow(1-t,2); c.flame.scale.x = startX*(1-ease); c.flame.scale.y = startY*(1-ease); if(t<1) requestAnimationFrame(step); });
        for(let s=0;s<3;s++){
          const smoke = new THREE.Mesh(smokeGeo, smokeMat.clone());
          smoke.material.opacity = 0.22; smoke.position.set(c.group.position.x,1.9,c.group.position.z);
          smoke.rotation.x = -0.3; scene.add(smoke);
          smokes.push({mesh:smoke,life:0,velY:0.006 + Math.random()*0.012,velX:(Math.random()-0.5)*0.002});
        }
      });
      message.textContent = 'Mumlar sÃ¶ndÃ¼ â€” ÅžarkÄ± baÅŸlÄ±yor...';
      try{ if(ytPlayerReady && ytPlayer && ytPlayer.playVideo) ytPlayer.playVideo(); }catch(e){console.warn('YT play error',e)}
    }

    // animation
    function animate(now){
      requestAnimationFrame(animate);
      // update smoke
      for(let i=smokes.length-1;i>=0;i--){ const s=smokes[i]; s.life += 1/60; s.mesh.position.y += s.velY; s.mesh.position.x += s.velX; s.mesh.material.opacity *= 0.992; if(s.life>2.5){ scene.remove(s.mesh); smokes.splice(i,1); }}
      cakeGroup.rotation.y += 0.0025;
      renderer.render(scene,camera);
      if(!blown) checkBlow();
    }
    animate();

    window.addEventListener('resize', ()=>{ camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); });

    startBtn.addEventListener('click', async ()=>{
      if(window.AudioContext && typeof AudioContext !== 'undefined' && audioContext && audioContext.state === 'suspended') await audioContext.resume().catch(()=>{});
      startScreen.style.display='none';
      const div = document.createElement('div'); div.style.display='none'; div.id='ytwrap'; document.body.appendChild(div);
      const iframe = document.createElement('div'); iframe.id='ytplayer'; div.appendChild(iframe);
    });

    resetBtn.addEventListener('click', ()=>{ location.reload(); });

    micBtn.addEventListener('touchstart', ()=>{ enableMic(); });
    micBtn.addEventListener('mousedown', ()=>{ enableMic(); });

  })();
  </script>
</body>
</html>
